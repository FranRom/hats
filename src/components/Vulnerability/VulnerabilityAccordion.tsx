import React, { useState } from "react";
import "../../styles/Vulnerability/VulnerabilityAccordion.scss";
import AccordionCard from "./AccordionCard";
import ProjectSelect from "./ProjectSelect";
import Description from "./Description";
import PayDeposit from "./PayDeposit";
import ContactInfo from "./ContactInfo";
import Terms from "./Terms";

export interface ICardData {
  verified: boolean,
  data?: any
}

export interface IAccordionContext {
  currentCard: number
  toggleCard: Function
  submitCard: Function
}

export const AccordionContext = React.createContext<IAccordionContext>({currentCard: 1, toggleCard: () => {}, submitCard: () => {}});

const initData: { [id: number]: ICardData } = {
  1: {
    verified: false,
    data: {
      projectName: "",
      projectId: ""
    }
  },
  2: {
    verified: false,
    data: {
      title: "",
      description: ""
    }
  },
  3: {
    verified: false
  },
  4: {
    verified: false,
    data: {
      username: ""
    }
  },
  5: {
    verified: false
  }
}

export default function VulnerabilityAccordion() {
  const cachedData = JSON.parse(localStorage.getItem("submitVulnerabilityData") || JSON.stringify(initData));

  // Get the first card that hasn't been verified yet
  const [currentCard, setCurrentCard] = useState(Number(Object.keys(cachedData).find(key => cachedData[key].verified === false )));
  const [cards, setCards] = useState(cachedData);

  React.useEffect(() => {
    localStorage.setItem("submitVulnerabilityData", JSON.stringify(cards));
  }, [cards])

  const toggleCard = (card: number) => {
    setCurrentCard(card);
  }

  const submitCard = (card: number, data?: any) => {
    setCards({ ...cards, [card]: { verified: true, data: data } });
    setCurrentCard(card + 1);
  }

  return <div className="content vulnerability-wrapper">
    <AccordionContext.Provider value={{ currentCard: currentCard, toggleCard: toggleCard, submitCard: submitCard }}>
      <AccordionCard id={1} title="Select Project" data={cards[1]}>
        <ProjectSelect />
      </AccordionCard>
      <AccordionCard id={2} title="Describe vulnerability" data={cards[2]}>
        <Description data={cards[2].data} />
      </AccordionCard>
      <AccordionCard id={3} title="Application Deposit" data={cards[3]}>
        <PayDeposit verified={cards[3].verified} />
      </AccordionCard>
      <AccordionCard id={4} title="Contact information" data={cards[4]}>
        <ContactInfo />
      </AccordionCard>
      <AccordionCard id={5} title="Terms and conditions" data={cards[5]}>
        <Terms />
      </AccordionCard>
    </AccordionContext.Provider>
  </div>
}
