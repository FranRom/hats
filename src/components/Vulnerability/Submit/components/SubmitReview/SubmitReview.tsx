import { useContext, useEffect, useState } from "react";
import { useTranslation } from "react-i18next";
import { useDispatch, useSelector } from "react-redux";
import { IVault } from "../../../../../types/types";
import { RootState } from "../../../../../reducers";
import { AccordionContext } from "../../../VulnerabilityAccordion";
import { CHAINID } from "../../../../../settings";
import Loading from "../../../../Shared/Loading";
import { onChainTransactionSuccess } from "../../Submit";
import sha256 from "sha256";
import EditIcon from "../../../../../assets/icons/edit.svg";
import { Card, IVulnerabilityData } from "../../../types";
import "./index.scss";
import { ChainId, useEthers } from "@usedapp/core";
import { useClaim } from "hooks/contractHooks";

const openpgp = require("openpgp");

interface IProps {
  cards: IVulnerabilityData
  setBotStatus: Function
}

export default function SubmitReview({ cards, setBotStatus }: IProps) {
  const dispatch = useDispatch();
  const { t } = useTranslation();
  const { submitCard, toggleCard } = useContext(AccordionContext);
  const isVerified = cards.project.verified && cards.contact.verified && cards.description.verified && cards.terms.verified;
  const vault = useSelector((state: RootState) => state.dataReducer.vaults?.filter((vault: IVault) => vault.id === cards.project.projectId)[0]);
  const description = vault && vault.description;
  const committeeCheckedIn = vault && vault.parentVault.committeeCheckedIn;
  const { account } = useEthers()
  const master = vault!.parentVault.master
  const { send: submit, state: submitState } = useClaim(master.address)
  const [encryptedData, setEncryptedData] = useState<string | undefined>();

  const submittingVulnerability = submitState.status === 'Mining'
  const showSubmitWarning = !isVerified || !account;

  const handleSubmit = async () => {
    const encryptedData = await pgpData();
    setEncryptedData(encryptedData);
    const sha256Encrypted = sha256(encryptedData.replace(/\s+/g, ''));
    submit(sha256Encrypted);
  }

  useEffect(() => {
    if (submitState.status === 'Success') {
      const route = vault!.name
      const telegramBotUrl = `${description?.["communication-channel"]?.["committee-bot"]}`;
      onChainTransactionSuccess(submitCard, telegramBotUrl, encryptedData!, submitState.receipt?.transactionHash!, route, setBotStatus, dispatch);
    }
  }, [encryptedData, submitState, setBotStatus, dispatch, vault, description, submitCard])

  const pgpData = async () => {
    const dataToEncrypt = `
    Project Name: ${cards.project.projectName}
    Title: ${cards.description.title}
    Description: ${cards.description.description}
    Telegram username: ${cards.contact.username}
    Beneficiary: ${cards.contact.beneficiary}
    `
    const publicKeyArmored = `${description?.["communication-channel"]?.["pgp-pk"]}`;
    const publicKey = await openpgp.readKey({ armoredKey: publicKeyArmored });
    const encrypted = await openpgp.encrypt({
      message: await openpgp.createMessage({ text: dataToEncrypt }),
      encryptionKeys: publicKey
    });

    return encrypted;
  }

  return (
    <div className="submit-review-wrapper">
      {t("SubmitVulnerability.Submit.review-notice")}

      <div className="review-details-container">
        <div className="project-and-contact-container">
          <div className="review-item project-name-item">
            <div className="item-title-container">
              <span>Project Name:</span>
              <img src={EditIcon} alt="edit" onClick={() => toggleCard(Card.project)} />
            </div>
            <span className="item-value">{cards.project.projectName}</span>
          </div>
          <div className="review-item">
            <div className="item-title-container">
              <span>Contact Information:</span>
              <img src={EditIcon} alt="edit" onClick={() => toggleCard(Card.contact)} />
            </div>
            <span className="item-value">{cards.contact.username}</span>
          </div>
        </div>

        <div className="description-container">
          <div className="review-item">
            <div className="item-title-container">
              <span>Vulnerability Description:</span>
              <img src={EditIcon} alt="edit" onClick={() => toggleCard(Card.description)} />
            </div>
            <span className="item-value">{cards.description.description}</span>
          </div>
        </div>
      </div>

      <button disabled={!isVerified || submittingVulnerability || !account || (vault && !committeeCheckedIn)} onClick={handleSubmit}>SUBMIT</button>
      {vault && !committeeCheckedIn && <span className="error-label">COMMITTEE IS NOT CHECKED IN YET!</span>}
      {showSubmitWarning && <span className="error-label">{`Please make sure you completed all steps and your wallet is connected to ${ChainId[CHAINID]}`}</span>}
      {(submittingVulnerability) && <Loading fixed extraText="Submitting might take longer than usual" domElement={document.getElementById("accrodionWrapper") as HTMLElement} zIndex={0} />}
    </div>
  )
}
