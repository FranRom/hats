import React, { useMemo, useState } from "react";
import "../../styles/Vulnerability/Submit.scss";
import sha256 from "sha256";
import { createTransaction, submitVulnerability } from "../../actions/contractsActions";
import { useDispatch, useSelector } from "react-redux";
import { AccordionContext, ICardData, initData } from "./VulnerabilityAccordion";
import Loading from "../Shared/Loading";
import { fromWei, isProviderAndNetwork } from "../../utils";
import { RootState } from "../../reducers";
import axios from "axios";
import { toggleInTransaction, toggleNotification } from "../../actions";
import { DEFAULT_ERROR_MESSAGE, IPFS_PREFIX, NotificationType, RC_TOOLTIP_OVERLAY_INNER_STYLE, Colors, RoutePaths } from "../../constants/constants";
import { ISeverity } from "../../types/types";
import millify from "millify";
import Tooltip from "rc-tooltip";
import InfoIcon from "../../assets/icons/info.icon";
import ZoomIcon from "../../assets/icons/zoom.icon";
import Modal from "../Shared/Modal";
import NFTPrize from "../NFTPrize";
import DiscordIcon from "../../assets/icons/social/discord.icon";
const openpgp = require("openpgp");

interface IProps {
  cards: { [id: number]: ICardData }
  setCards: Function
}

export default function Submit(props: IProps) {
  const { cards } = props;
  const dispatch = useDispatch();
  const isVerified = cards[1].verified && cards[2].verified && cards[3].verified;
  const [inTransaction, setInTransaction] = useState(false);
  const [pendingWalletAction, setPendingWalletAction] = useState(false);
  const provider = useSelector((state: RootState) => state.web3Reducer.provider);
  const vault = cards[1].data;
  const [showNFTModal, setShowNFTModal] = useState(false);
  const [modalNFTData, setModalNFTData] = useState(null);
  const [termsOfUse, setTermsOfUse] = useState(false);
  const { submitCard } = React.useContext(AccordionContext);

  const prizes = useMemo(() => vault?.description?.severities?.map((severity: ISeverity, index: number) => {
    let rewardPrice = "-";
    const rewardPercentage = (Number(vault.rewardsLevels[severity.index]) / 10000) * 100;
    if (vault.tokenPrice && vault.honeyPotBalance) {
      rewardPrice = millify(Number(fromWei(vault.honeyPotBalance)) * rewardPercentage * vault.tokenPrice);
    }

    return (
      <tr key={index} className={`${severity.name.toLocaleLowerCase()}`}>
        <td>{severity.name.toUpperCase()}</td>
        <td>
          <b>{`${rewardPercentage}%`}</b> of vault &#8776; {`$${rewardPrice}`}&nbsp;
          <Tooltip
            overlay="Prizes are in correlation to the funds in the vault and may change at any time"
            overlayClassName="tooltip"
            overlayInnerStyle={RC_TOOLTIP_OVERLAY_INNER_STYLE}>
            <span><InfoIcon width="15" height="15" fill={Colors.white} /></span>
          </Tooltip>
        </td>
        {
          severity?.["nft-metadata"] && <td className="nft-wrapper" onClick={() => { setShowNFTModal(true); setModalNFTData(severity as any); }}>
            <img
              className="nft-image"
              src={`${IPFS_PREFIX}${severity?.["nft-metadata"]?.image?.substring(12)}`}
              alt="NFT" />
            <ZoomIcon />
          </td>
        }
      </tr>
    )
  }), [vault]);

  const submit = async () => {
    setInTransaction(true);
    setPendingWalletAction(true);
    const encryptedData = await pgpData();
    const telegramBotUrl = `${vault?.description?.["communication-channel"]?.["committee-bot"]}`;
    const sha256Encrypted = sha256(encryptedData.replace(/\s+/g, ''));
    try {
      await createTransaction(
        async () => await submitVulnerability(vault.masterAddress, sha256Encrypted),
        () => { setPendingWalletAction(false) },
        async () => {
          await axios.post(telegramBotUrl, { msg: encryptedData });
          submitCard(4);
          //localStorage.removeItem("submitVulnerabilityData");
          //props.setCards(initData);
        },
        () => { setPendingWalletAction(false); },
        dispatch,
        "The vulnerability was submitted successfully", 2, true);
      dispatch(toggleInTransaction(false));
    } catch (err) {
      console.error(err);
      dispatch(toggleNotification(true, NotificationType.Error, err?.message ?? DEFAULT_ERROR_MESSAGE, true));
    }
    setInTransaction(false);
  }

  const pgpData = async () => {
    const dataToEncrypt = `
    Project Name: ${vault.projectName}
    Title: ${cards[3].data.title}
    Description: ${cards[3].data.description}
    Telegram username: ${cards[2].data.username}
    `
    const publicKeyArmored = `${vault?.description?.["communication-channel"]?.["pgp-pk"]}`;

    const publicKey = await openpgp.readKey({ armoredKey: publicKeyArmored });

    const encrypted = await openpgp.encrypt({
      message: await openpgp.createMessage({ text: dataToEncrypt }),
      encryptionKeys: publicKey
    });
    return encrypted;
  }

  return <>
    <div className={inTransaction ? "submit-wrapper loading card-content" : "submit-wrapper card-content"}>
      {cards[4].verified ? (
        <>
          <div>Hey new Hatter, thank you for your submission!</div>
          <div>Become an active member of our community and let us know what you think.</div>
          <div className="submit-complete-actions-wrapper">
            <button onClick={() => props.setCards(initData)}>SUBMIT NEW VULNERABILITY</button>
            <button className="discord-btn" onClick={() => window.open("https://discord.gg/xDphwRGyW7")}>
              <span>JOIN US ON DISCORD</span>
              <DiscordIcon fill={Colors.darkBlue} />
            </button>
          </div>
        </>) : (
        <>
          <div>After submitting a vulnerability you will receive the committee receipt and processing timeline via Telegram. The committee triaged is estimated between 5-7 days</div>
          <div>{cards[1].verified ? "Prizes are allocated by vulnerability level:" : "Please choose project to view prizes"}</div>
          {cards[1].verified && (
            <table>
              <tbody>
                <tr>
                  <th>Level</th>
                  <th>Prize</th>
                  <th>NFT</th>
                </tr>
                {prizes}
              </tbody>
            </table>)}
          <div className="submit-action-wrapper">
            <input type="checkbox" checked={termsOfUse} onChange={() => setTermsOfUse(!termsOfUse)} />
            <label>I UNDERSTAND AND AGREE TO THE <u><a target="_blank" rel="noopener noreferrer" href={RoutePaths.terms_of_service}>TERMS OF USE</a></u></label>
            <button disabled={!isVerified || inTransaction || !isProviderAndNetwork(provider) || !termsOfUse} onClick={submit}>SUBMIT</button>
          </div>
          {(pendingWalletAction || inTransaction) && <Loading extraText="Submitting might take longer than usual" domElement={document.getElementById("accrodionWrapper") as HTMLElement} />}
        </>)}
    </div>
    {
      showNFTModal &&
      <Modal title="NFT PRIZE" setShowModal={setShowNFTModal} maxWidth="600px" width="60%" height="fit-content">
        <NFTPrize data={modalNFTData as any} />
      </Modal>
    }
  </>
}
